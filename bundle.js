(()=>{"use strict";const e={refreshRate:3e3,duration:3,bucketSize:5,graphOptions:{legend:{position:"none"},titleTextStyle:{color:"white"},hAxis:{format:"HH:mm:ss",textStyle:{color:"#999999"},gridlines:{color:"none"}},vAxis:{textStyle:{color:"#999999"},gridlines:{color:"none"}},chartArea:{width:"80%",height:"75%"},backgroundColor:"none"}};function t(e){e.setAttribute("hidden","hidden")}function n(e){e.removeAttribute("hidden")}function a(e){const{chartDom:t}=e;e.googleChart=new google.visualization.ColumnChart(t)}function o(e){const{chartDom:t}=e;e.googleChart=new google.visualization.AreaChart(t)}function r({chartDom:e}){e.innerHTML=""}function i(e,{googleChart:t,options:n}){const a=google.visualization.arrayToDataTable(e);t.draw(a,n)}function c(e){let t;return fetch(e).then((e=>(t=e.status,e.json()))).then((e=>{if(200!==t)throw e;return e}))}function s(e){return(t,n)=>function(e,t,n){return c(function(e,t,n){return`${e}?from=${encodeURIComponent(t)}&duration=${n}`}(`https://queue-qna.herokuapp.com${e}`,t,n))}(e,t,n)}const l=s("/errors"),u=s("/arrivals"),d=s("/departures"),h=s("/processing-times"),g=s("/lengths");function m(t,n=e.bucketSize){return t-t%n}function p(t,n,a){const{bucketSize:o}=e,r=n.unix(),i=a.unix(),c={},s=[];for(let e=m(r);e<i;e+=o)c[e]=0,s.push(e);t.forEach((e=>{c[m(e)]+=1}));const l=[["Timestamp","Count"]];return s.forEach((e=>{l.push([new Date(1e3*e),c[e]])})),l}const f=t,y=n,C=t,D=n,v={"error-rate":{options:{...e.graphOptions,title:"errors/sec",colors:["#ff0000"]},createChart:a,clearChart:r,draw:i,payloadToData:function(e,t,n){return p(e.map((({timestamp:e})=>e)),t,n)},getPayload:l},"arrival-rate":{options:{...e.graphOptions,title:"arrivals/sec",colors:["#00ff00"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:u},"departure-rate":{options:{...e.graphOptions,title:"departure/sec",colors:["#0000ff"]},createChart:a,clearChart:r,draw:i,payloadToData:p,getPayload:d},"average-processing-time":{options:{...e.graphOptions,title:"average processing time/sec",colors:["#FF00FF"]},createChart:o,clearChart:r,draw:i,payloadToData:function(e,t,n){const a=t.unix(),o=n.unix(),r={};e.forEach((({received_time:e,processing_time:t})=>{r[e]||(r[e]=[]),r[e].push(t)}));const i=[["Timestamp","Average"]];for(let e=a;e<o;e++)if(r[e]){const t=r[e],n=t.reduce(((e,t)=>e+t),0)/t.length;i.push([new Date(1e3*e),n])}else i.push([new Date(1e3*e),0]);return i},getPayload:h},"queue-length":{options:{...e.graphOptions,title:"sampled queue lengths",colors:["#FFFF00"]},createChart:o,clearChart:r,draw:i,payloadToData:function(e){const t=[["Timestamp","Average"]];return e.length?[...t,...e.map((({timestamp:e,length:t})=>[new Date(1e3*e),t]))]:[...t,[0,0]]},getPayload:g},"waiting-time-stats":{options:{colors:["#006400"]},panels:[{key:"mean",label:"Average Waiting Time"},{key:"median",label:"Median Waiting Time"},{key:"max",label:"Max Waiting Time"},{key:"min",label:"Min Waiting Time"}],createChart:function(e){const{panels:t,isDrawn:n,chartDom:a}=e;n||(t.forEach((e=>{const{label:t}=e,n=document.createElement("div");n.classList.add("panel"),a.appendChild(n);const o=document.createElement("p");o.classList.add("label"),o.innerHTML=t,n.appendChild(o);const r=document.createElement("p");r.classList.add("count"),n.appendChild(r),e.countDom=r})),e.isDrawn=!0)},clearChart:()=>{},draw:function(e,{panels:t,options:n}){t.forEach((({countDom:t,key:a})=>{(e[a]||0===e[a])&&(t.innerHTML=e[a].toFixed(1),[t.parentNode.style.backgroundColor]=n.colors)}))},payloadToData:function(e){const t=dayjs().unix(),n=e.map((({arrival:e})=>Math.max(0,t-e)));var a;return n.sort(((e,t)=>e-t)),{mean:(a=n).length?a.reduce(((e,t)=>e+t),0)/a.length:0,median:function(e){if(!e.length)return 0;const t=Math.floor(e.length/2);return e.length%2?e[t]:(e[t-1]+e[t])/2}(n),max:n[n.length-1]||0,min:n[0]||0}},getPayload:()=>c("https://queue-qna.herokuapp.com/customers")}};function E(t){const n=v[t];if(!n.canDrawChart())return;const{getPayload:a,payloadToData:o,draw:r,loadingAnimation:i,warningIcon:c}=n,{duration:s}=e,[l,u,d]=function(e){const t=dayjs().utc(),n=t.subtract(e,"minute"),a=n.format("YYYY-MM-DDTHH:mm:ss");return[t,n,a]}(s);D(i),a(d,s).then((e=>{if(!n.canDrawChart())return;f(c);const t=o(e,u,l);r(t,n)})).catch((e=>{y(c),console.error(e)})).finally((()=>{C(i)}))}let b,w;function L(t){clearInterval(b),b=setInterval((()=>{t.forEach((e=>{E(e)}))}),e.refreshRate)}function T(e,a){const o=document.getElementById("chart-containers");e.forEach((e=>{const r=a[e],i=r.containerDom,c=i.querySelector(".minimize-icon"),s=i.querySelector(".maximize-icon"),l=r.canDrawChart;r.canDrawChart=()=>l()&&function(e){return!w||w===e}(e),c.addEventListener("click",(()=>{w="",r.clearChart(a[e]),i.classList.toggle("full-screen-chart",!1),o.classList.toggle("normal",!0),o.classList.toggle("full-screen",!1),t(c),n(s),r.createChart(a[e]),E(e)})),s.addEventListener("click",(()=>{!function(e){w=e}(e),i.classList.toggle("full-screen-chart",!0),o.classList.toggle("normal",!1),o.classList.toggle("full-screen",!0),t(s),n(c),E(e)}))}))}function k(e,t){e.addEventListener("dragover",(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"})),e.addEventListener("drop",(n=>{n.preventDefault();const a=n.dataTransfer.getData("text/plain"),o=t[a].containerDom;e.parentNode.insertBefore(o,e)}))}function x(e,t){const n=document.getElementById("chart-containers");k(document.getElementById("drop-zone"),t),e.forEach((e=>{const a=t[e].containerDom;a.setAttribute("draggable",!0),a.addEventListener("dragstart",(t=>{n.classList.add("dragging"),t.dataTransfer.setData("text/plain",e),t.dataTransfer.dropEffect="move"})),a.addEventListener("dragend",(()=>{n.classList.remove("dragging")})),k(a,t)}))}Object.keys(v).forEach((e=>{v[e].canDrawChart=()=>!0}));const S=[{label:"Refresh Rate (ms)",initial:e.refreshRate,type:"number",onChange:(t,n,a)=>{e.refreshRate=t,L(n)}},{label:"Duration (min)",initial:e.duration,type:"number",onChange:t=>{e.duration=t}},{label:"Bucket Size (sec)",initial:e.bucketSize,type:"number",onChange:t=>{e.bucketSize=parseFloat(t)}}];function A(e,t){const n=document.getElementById("config-container");e.forEach((e=>{S.push(function(e,t){return{label:`${e} color`,type:"color",initial:t.options.colors[0]||"black",onChange:n=>{t.options.colors=[n],E(e)}}}(e,t[e]))})),S.forEach((({label:a,type:o,onChange:r,initial:i})=>{const c=document.createElement("input");c.setAttribute("type",o),c.value=i,c.addEventListener("focusout",(()=>{r(c.value,e,t)}));const s=document.createElement("label");s.innerHTML=a;const l=document.createElement("div");l.classList.add("config"),l.appendChild(s),l.appendChild(c),n.appendChild(l)}));let a=!0;document.getElementById("toggle-config").addEventListener("click",(()=>{n.classList.toggle("hidden",!a),a=!a}))}google.charts.setOnLoadCallback((function(){!function(e){const t=Object.keys(v);t.forEach((e=>{const t=v[e],n=document.getElementById(e);t.containerDom=n,t.chartDom=n.querySelector(".chart"),t.loadingAnimation=n.querySelector(".loading-icon"),t.warningIcon=n.querySelector(".warning-icon"),t.createChart(t),E(e)})),e.forEach((e=>{e(t,v)}))}([L,T,x,A])}))})();